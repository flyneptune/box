function initRenderer(){renderer=new THREE.WebGLRenderer({antialias:!0}),canvas=renderer.domElement,renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(canvas),window.addEventListener("resize",doResize,!1),clock=new THREE.Clock,renderer.setClearColor("rgb(0,0,0)"),renderer.shadowMapEnabled=!0,(scene=new THREE.Scene).background=new THREE.Color("rgb(0,0,0)"),cont=new THREE.Group,scene.add(cont)}function doResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function initHelpers(){(controls=new THREE.OrbitControls(camera,renderer.domElement)).target=new THREE.Vector3(250,80,250)}function showAxes(){var e=new THREE.Geometry,t=new THREE.Vector3(0,0,0);e.vertices.push(t);var n=new THREE.PointsMaterial({color:"cyan",size:10,sizeAttenuation:!1}),a=new THREE.Points(e,n);scene.add(a),drawLine(new THREE.Vector3(0,0,0),new THREE.Vector3(100,0,0),"rgb(255,0,0)"),drawLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0,100,0),"rgb(0,255,0)"),drawLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,100),"rgb(0,0,255)")}function drawLine(e,t,n){var a=new THREE.Geometry;a.vertices.push(e),a.vertices.push(t);var o=new THREE.LineBasicMaterial({color:n,linewidth:2}),r=(new THREE.LineBasicMaterial({color:n,linewidth:2}),new THREE.LineBasicMaterial({color:n,linewidth:2}),new THREE.Line(a,o,THREE.LineStrip));scene.add(r)}function initCamera(){(camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,4e3)).position.set(250,400,800),camera.lookAt(scene.position),scene.add(camera)}function init(){initRenderer(),initCamera(),initLights(),initLoadingManager(),initMaterials(),spawnWorld(),initHelpers(),requestAnimationFrame(main)}function initLights(){pLight1=newPointLight(0,lY,0,16777215,1),pLight2=newPointLight(550,lY,-50,16777215,1),pLight3=newPointLight(-50,lY,550,16777215,1)}function newPointLight(e,t,n,a,o){var r=new THREE.PointLight(a,o,0,2);return r.castShadow=!1,r.position.set(e,t,n),scene.add(r),r}function initLoadingManager(){var e=document.createElement("div"),t=document.createElement("div"),n=document.createElement("div");e.appendChild(t),e.appendChild(n),document.body.appendChild(e),n.innerHTML="Loading...",e.style="position: absolute;\tz-index: 500;right:0px;\t\tleft:0px;\t\ttop:0px;\t\tbottom:0px;\t\tmargin: auto;\twidth:300px;height:40px;background-color:#555555;border-radius: 4px;",t.style="width:25px;\t\theight:40px;\t\tbackground-color:#5E9CE5;\tborder-radius: 4px;",n.style="color:#fff;position: absolute;z-index:2;right:0px;left:0px;top:10px;bottom:0px;width:300px;height:40px;\ttext-align:center;",THREE.DefaultLoadingManager.onStart=function(e,t,n){},THREE.DefaultLoadingManager.onProgress=function(e,a,o){var r=100*a/o;n.innerHTML="Loading: "+Math.round(r)+" %";var i=300*r/100;t.style.width=i+"px"},THREE.DefaultLoadingManager.onLoad=function(){e.style.display="none",assetsLoaded=!0},THREE.DefaultLoadingManager.onError=function(e){console.log("error loading asset "+e)}}function main(){if(assetsLoaded){for(var e=performance.now()/500,t=0;t<arBox.length;t++){(n=arBox[t]).position.y=20*Math.sin(n.position.x+n.position.z+e)}if(sphere.position.x=250+100*Math.sin(e/2),sphere.position.z=250+100*Math.cos(e/2),h=Math.sin(e/25),s=1,l=.5,pLight1.color.setHSL(h,s,l),updateCubeCams)for(t=0;t<arCubeCameras.length;t++){var n=arCubeCameras[t][0],a=arCubeCameras[t][1];n.visible=!1,a.position.copy(n.position),a.update(renderer,scene),n.visible=!0}controls.update(),renderer.render(scene,camera)}requestAnimationFrame(main)}function initMaterials(){maxAnisotropy=renderer.getMaxAnisotropy();var e,t;e="materials/uv/",t=new THREE.Vector2(1,1),uvMat=createMaterial(e,t,!1,1,!1,0,.5,0,0,1),e="materials/uv/",t=new THREE.Vector2(1,1),phongMat=createPhongMaterial(e,t,1),(sphereMat=new THREE.MeshPhysicalMaterial({})).metalness=1,sphereMat.roughness=0}function createPhongMaterial(e,t,n){var a=new THREE.MeshPhongMaterial({});return a.specular=new THREE.Color(16777215),a.shininess=30,a}function createMaterial(e,t,n,a,o,r,i,s,c,p){var d=new THREE.MeshPhysicalMaterial({});return d.reflectivity=i,d.clearCoat=s,d.clearCoatRoughness=c,d.map=(new THREE.TextureLoader).load(e+"albedo"),d.map.anisotropy=maxAnisotropy,d.map.wrapS=THREE.RepeatWrapping,d.map.wrapT=THREE.RepeatWrapping,d.map.repeat.set(p,p),d.normalMap=(new THREE.TextureLoader).load(e+"normal"),d.normalMap.anisotropy=maxAnisotropy,d.normalScale=t,d.normalMap.wrapS=THREE.RepeatWrapping,d.normalMap.wrapT=THREE.RepeatWrapping,d.normalMap.repeat.set(p,p),n&&(d.metalnessMap=(new THREE.TextureLoader).load(e+"metalness"),d.metalnessMap.anisotropy=maxAnisotropy,d.metalnessMap.wrapS=THREE.RepeatWrapping,d.metalnessMap.wrapT=THREE.RepeatWrapping,d.metalnessMap.repeat.set(p,p)),d.metalness=a,o&&(d.roughnessMap=(new THREE.TextureLoader).load(e+"roughness"),d.roughnessMap.anisotropy=maxAnisotropy,d.roughnessMap.wrapS=THREE.RepeatWrapping,d.roughnessMap.wrapT=THREE.RepeatWrapping,d.roughnessMap.repeat.set(p,p)),d.roughness=r,d}function spawnWorld(){for(var e=0;e<cols;e++)for(var t=0;t<rows;t++)arBox.push(spawnBox(e*boxSize+boxSize/2,0,t*boxSize+boxSize/2));sphere=spawnSphere()}function spawnBox(e,t,n){var a=new THREE.BoxGeometry(boxSize,boxSize,boxSize),o=phongMat.clone();o.color=new THREE.Color;o.color.setRGB(.2,.2,.2);var r=new THREE.Mesh(a,o);return r.castShadow=!0,r.receiveShadow=!0,cont.add(r),r.position.set(e,t,n),r}function spawnSphere(){var e=new THREE.SphereGeometry(40,60,60),t=sphereMat.clone(),n=new THREE.Mesh(e,t);n.castShadow=!1,n.receiveShadow=!1,scene.add(n),n.position.set(100,100,100);var a=new THREE.CubeCamera(cubeCamNear,cubeCamFar,cubeCamRes);return a.renderTarget.texture.minFilter=THREE.LinearMipMapLinearFilter,scene.add(a),n.material.envMap=a.renderTarget.texture,n.material.envMap.anisotropy=maxAnisotropy,n.material.envMapIntensity=1,arCubeCameras.push([n,a]),a.position.copy(n.position),n}function spawnTestMesh(){var e=new THREE.SphereGeometry(20,60,60),t=darkMarbleMat.clone(),n=new THREE.Mesh(e,t);n.castShadow=!0,n.receiveShadow=!0,scene.add(n),n.position.set(50,20,50);var a=new THREE.CubeCamera(cubeCamNear,cubeCamFar,cubeCamRes);a.renderTarget.texture.minFilter=THREE.LinearMipMapLinearFilter,scene.add(a),n.material.envMap=a.renderTarget.texture,n.material.envMap.anisotropy=maxAnisotropy,n.material.envMapIntensity=1,arCubeCameras.push([n,a]),a.position.copy(n.position)}function callbackPortal(e,t){fix(e),e.normalsNeedUpdate=!0,e.verticesNeedUpdate=!0;var n=floorMat.clone(),a=new THREE.Mesh(e,n);a.castShadow=!0,a.receiveShadow=!0,cont.add(a);var o=new THREE.CubeCamera(cubeCamNear,cubeCamFar,cubeCamRes);o.renderTarget.texture.minFilter=THREE.LinearMipMapLinearFilter,cont.add(o),a.material.envMap=o.renderTarget.texture,a.material.envMap.anisotropy=maxAnisotropy,a.material.envMapIntensity=1,arCubeCameras.push([a,o]);a.scale.set(20,20,20),o.position.copy(a.position),e.computeBoundingBox(),o.position.y=e.boundingBox.max.y/2*20,portal=a}THREE.OrbitControls=function(e,t){function n(){return Math.pow(.95,b.zoomSpeed)}function a(e){M.theta-=e}function o(e){M.phi-=e}function r(e){b.object instanceof THREE.PerspectiveCamera?y/=e:b.object instanceof THREE.OrthographicCamera?(b.object.zoom=Math.max(b.minZoom,Math.min(b.maxZoom,b.object.zoom*e)),b.object.updateProjectionMatrix(),x=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),b.enableZoom=!1)}function i(e){b.object instanceof THREE.PerspectiveCamera?y*=e:b.object instanceof THREE.OrthographicCamera?(b.object.zoom=Math.max(b.minZoom,Math.min(b.maxZoom,b.object.zoom/e)),b.object.updateProjectionMatrix(),x=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),b.enableZoom=!1)}function s(e){if(!1!==b.enabled){if(e.preventDefault(),e.button===b.mouseButtons.ORBIT){if(!1===b.enableRotate)return;!function(e){L.set(e.clientX,e.clientY)}(e),f=R.ROTATE}else if(e.button===b.mouseButtons.ZOOM){if(!1===b.enableZoom)return;!function(e){N.set(e.clientX,e.clientY)}(e),f=R.DOLLY}else if(e.button===b.mouseButtons.PAN){if(!1===b.enablePan)return;!function(e){S.set(e.clientX,e.clientY)}(e),f=R.PAN}f!==R.NONE&&(document.addEventListener("mousemove",c,!1),document.addEventListener("mouseup",p,!1),b.dispatchEvent(T))}}function c(e){if(!1!==b.enabled)if(e.preventDefault(),f===R.ROTATE){if(!1===b.enableRotate)return;!function(e){O.set(e.clientX,e.clientY),P.subVectors(O,L);var t=b.domElement===document?b.domElement.body:b.domElement;a(2*Math.PI*P.x/t.clientWidth*b.rotateSpeed),o(2*Math.PI*P.y/t.clientHeight*b.rotateSpeed),L.copy(O),b.update()}(e)}else if(f===R.DOLLY){if(!1===b.enableZoom)return;!function(e){z.set(e.clientX,e.clientY),k.subVectors(z,N),k.y>0?r(n()):k.y<0&&i(n()),N.copy(z),b.update()}(e)}else if(f===R.PAN){if(!1===b.enablePan)return;!function(e){A.set(e.clientX,e.clientY),j.subVectors(A,S),F(j.x,j.y),S.copy(A),b.update()}(e)}}function p(e){!1!==b.enabled&&(document.removeEventListener("mousemove",c,!1),document.removeEventListener("mouseup",p,!1),b.dispatchEvent(w),f=R.NONE)}function d(e){!1===b.enabled||!1===b.enableZoom||f!==R.NONE&&f!==R.ROTATE||(e.preventDefault(),e.stopPropagation(),function(e){e.deltaY<0?i(n()):e.deltaY>0&&r(n()),b.update()}(e),b.dispatchEvent(T),b.dispatchEvent(w))}function l(e){!1!==b.enabled&&!1!==b.enableKeys&&!1!==b.enablePan&&function(e){switch(e.keyCode){case b.keys.UP:F(0,b.keyPanSpeed),b.update();break;case b.keys.BOTTOM:F(0,-b.keyPanSpeed),b.update();break;case b.keys.LEFT:F(b.keyPanSpeed,0),b.update();break;case b.keys.RIGHT:F(-b.keyPanSpeed,0),b.update()}}(e)}function u(e){if(!1!==b.enabled){switch(e.touches.length){case 1:if(!1===b.enableRotate)return;!function(e){L.set(e.touches[0].pageX,e.touches[0].pageY)}(e),f=R.TOUCH_ROTATE;break;case 2:if(!1===b.enableZoom)return;!function(e){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,a=Math.sqrt(t*t+n*n);N.set(0,a)}(e),f=R.TOUCH_DOLLY;break;case 3:if(!1===b.enablePan)return;!function(e){S.set(e.touches[0].pageX,e.touches[0].pageY)}(e),f=R.TOUCH_PAN;break;default:f=R.NONE}f!==R.NONE&&b.dispatchEvent(T)}}function E(e){if(!1!==b.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===b.enableRotate)return;if(f!==R.TOUCH_ROTATE)return;!function(e){O.set(e.touches[0].pageX,e.touches[0].pageY),P.subVectors(O,L);var t=b.domElement===document?b.domElement.body:b.domElement;a(2*Math.PI*P.x/t.clientWidth*b.rotateSpeed),o(2*Math.PI*P.y/t.clientHeight*b.rotateSpeed),L.copy(O),b.update()}(e);break;case 2:if(!1===b.enableZoom)return;if(f!==R.TOUCH_DOLLY)return;!function(e){var t=e.touches[0].pageX-e.touches[1].pageX,a=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(t*t+a*a);z.set(0,o),k.subVectors(z,N),k.y>0?i(n()):k.y<0&&r(n()),N.copy(z),b.update()}(e);break;case 3:if(!1===b.enablePan)return;if(f!==R.TOUCH_PAN)return;!function(e){A.set(e.touches[0].pageX,e.touches[0].pageY),j.subVectors(A,S),F(j.x,j.y),S.copy(A),b.update()}(e);break;default:f=R.NONE}}function m(e){!1!==b.enabled&&(b.dispatchEvent(w),f=R.NONE)}function h(e){e.preventDefault()}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=150,this.maxDistance=1e3,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI/2-Math.PI/180*10,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=.4,this.enablePan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return v.phi},this.getAzimuthalAngle=function(){return v.theta},this.reset=function(){b.target.copy(b.target0),b.object.position.copy(b.position0),b.object.zoom=b.zoom0,b.object.updateProjectionMatrix(),b.dispatchEvent(g),b.update(),f=R.NONE},this.update=function(){var t=new THREE.Vector3,n=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),o=n.clone().inverse(),r=new THREE.Vector3,i=new THREE.Quaternion;return function(){var e=b.object.position;return t.copy(e).sub(b.target),t.applyQuaternion(n),v.setFromVector3(t),b.autoRotate&&f===R.NONE&&a(2*Math.PI/60/60*b.autoRotateSpeed),v.theta+=M.theta,v.phi+=M.phi,v.theta=Math.max(b.minAzimuthAngle,Math.min(b.maxAzimuthAngle,v.theta)),v.phi=Math.max(b.minPolarAngle,Math.min(b.maxPolarAngle,v.phi)),v.makeSafe(),v.radius*=y,v.radius=Math.max(b.minDistance,Math.min(b.maxDistance,v.radius)),b.target.add(C),t.setFromSpherical(v),t.applyQuaternion(o),e.copy(b.target).add(t),b.object.lookAt(b.target),!0===b.enableDamping?(M.theta*=1-b.dampingFactor,M.phi*=1-b.dampingFactor):M.set(0,0,0),y=1,C.set(0,0,0),!!(x||r.distanceToSquared(b.object.position)>H||8*(1-i.dot(b.object.quaternion))>H)&&(b.dispatchEvent(g),r.copy(b.object.position),i.copy(b.object.quaternion),x=!1,!0)}}(),this.dispose=function(){b.domElement.removeEventListener("contextmenu",h,!1),b.domElement.removeEventListener("mousedown",s,!1),b.domElement.removeEventListener("wheel",d,!1),b.domElement.removeEventListener("touchstart",u,!1),b.domElement.removeEventListener("touchend",m,!1),b.domElement.removeEventListener("touchmove",E,!1),document.removeEventListener("mousemove",c,!1),document.removeEventListener("mouseup",p,!1),window.removeEventListener("keydown",l,!1)};var b=this,g={type:"change"},T={type:"start"},w={type:"end"},R={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},f=R.NONE,H=1e-6,v=new THREE.Spherical,M=new THREE.Spherical,y=1,C=new THREE.Vector3,x=!1,L=new THREE.Vector2,O=new THREE.Vector2,P=new THREE.Vector2,S=new THREE.Vector2,A=new THREE.Vector2,j=new THREE.Vector2,N=new THREE.Vector2,z=new THREE.Vector2,k=new THREE.Vector2,V=function(){var e=new THREE.Vector3;return function(t,n){e.setFromMatrixColumn(n,0),e.multiplyScalar(-t),C.add(e)}}(),D=function(){var e=new THREE.Vector3;return function(t,n){e.setFromMatrixColumn(n,1),e.multiplyScalar(t),C.add(e)}}(),F=function(){var e=new THREE.Vector3;return function(t,n){var a=b.domElement===document?b.domElement.body:b.domElement;if(b.object instanceof THREE.PerspectiveCamera){var o=b.object.position;e.copy(o).sub(b.target);var r=e.length();r*=Math.tan(b.object.fov/2*Math.PI/180),V(2*t*r/a.clientHeight,b.object.matrix),D(2*n*r/a.clientHeight,b.object.matrix)}else b.object instanceof THREE.OrthographicCamera?(V(t*(b.object.right-b.object.left)/b.object.zoom/a.clientWidth,b.object.matrix),D(n*(b.object.top-b.object.bottom)/b.object.zoom/a.clientHeight,b.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),b.enablePan=!1)}}();b.domElement.addEventListener("contextmenu",h,!1),b.domElement.addEventListener("mousedown",s,!1),b.domElement.addEventListener("wheel",d,!1),b.domElement.addEventListener("touchstart",u,!1),b.domElement.addEventListener("touchend",m,!1),b.domElement.addEventListener("touchmove",E,!1),window.addEventListener("keydown",l,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}});var scene,cont,camera,light,renderer,canvas,controls,cameraAndLight,clock,stats,maxAnisotropy,uvMat,phongMat,sphereMat,sphere,pLight1,pLight2,pLight3,h,s,l,assetsLoaded=!1,loader=new THREE.JSONLoader,cubeCamNear=1,cubeCamFar=2100,cubeCamRes=512,updateCubeCams=!0,arCubeCameras=[],cols=10,rows=10,total=rows*cols,boxSize=50,arBox=[],color=new THREE.Color(16711680),lY=200;